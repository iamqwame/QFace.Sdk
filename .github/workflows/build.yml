name: Build and Publish NuGet Packages

on:
  push:
    branches: [main, master, developments]
    tags: ["v*.*.*"]
    paths:
      - 'src/**'
      - '.github/workflows/build.yml'
  workflow_dispatch:

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Build and Pack SDK Projects
        run: |
          mkdir -p ./nupkgs
          
          # First, build all QFace.Sdk projects to ensure everything compiles
          echo "üî® Building all QFace.Sdk projects..."
          for project_file in ./src/QFace.Sdk.*/*.csproj; do
            project_name=$(basename "$(dirname "$project_file")")
            
            # Skip template projects
            if [[ "$project_name" == "QFace.WebApi.Template" ]]; then
              echo "  ‚è≠ Skipping $project_name (template project)"
              continue
            fi
            
            echo "Building $project_name..."
            dotnet restore "$project_file"
            dotnet build "$project_file" -c Release --no-restore
            echo "  ‚úì Built $project_name"
          done
          
          # Build QimErp.Shared.Common
          if [ -f "./src/QimErp.Shared.Common/QimErp.Shared.Common.csproj" ]; then
            echo "Building QimErp.Shared.Common..."
            dotnet restore "./src/QimErp.Shared.Common/QimErp.Shared.Common.csproj"
            dotnet build "./src/QimErp.Shared.Common/QimErp.Shared.Common.csproj" -c Release --no-restore
            echo "  ‚úì Built QimErp.Shared.Common"
          fi
          
          echo ""
          echo "üì¶ Packing NuGet packages..."
          
          # Pack all QFace.Sdk projects with PackageId
          for project_file in ./src/QFace.Sdk.*/*.csproj; do
            project_name=$(basename "$(dirname "$project_file")")
            
            # Skip template projects
            if [[ "$project_name" == "QFace.WebApi.Template" ]]; then
              continue
            fi
            
            # Check if the project has PackageId (indicating it's a NuGet package)
            if grep -q "<PackageId>" "$project_file"; then
              # Check if project is explicitly set to not be packable
              if grep -q "<IsPackable>false</IsPackable>" "$project_file"; then
                echo "  ‚è≠ Skipping $project_name (IsPackable=false)"
                continue
              fi
              
              echo "  üì¶ Packing $project_file..."
              dotnet pack "$project_file" -c Release --no-build -o ./nupkgs
              echo "  ‚úì Packed $project_name"
              echo ""
            else
              if [[ "$project_name" != *".Tests"* ]]; then
                echo "  ‚è≠ Skipping $project_name (no PackageId found - not a NuGet package)"
              fi
            fi
          done
          
          # Pack QimErp.Shared.Common if it has PackageId
          if [ -f "./src/QimErp.Shared.Common/QimErp.Shared.Common.csproj" ]; then
            if grep -q "<PackageId>" "./src/QimErp.Shared.Common/QimErp.Shared.Common.csproj"; then
              if ! grep -q "<IsPackable>false</IsPackable>" "./src/QimErp.Shared.Common/QimErp.Shared.Common.csproj"; then
                echo "  üì¶ Packing QimErp.Shared.Common..."
                dotnet pack "./src/QimErp.Shared.Common/QimErp.Shared.Common.csproj" -c Release --no-build -o ./nupkgs
                echo "  ‚úì Packed QimErp.Shared.Common"
                echo ""
              fi
            fi
          fi
          
          echo ""
          echo "üì¶ Created packages:"
          ls -la ./nupkgs/ || echo "No packages were created"

      - name: Publish to NuGet
        if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/developments' || startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch') && hashFiles('./nupkgs/*.nupkg') != ''
        run: |
          if [ -z "$(ls -A ./nupkgs/*.nupkg 2>/dev/null)" ]; then
            echo "No packages to publish"
            exit 0
          fi
          
          for package in ./nupkgs/*.nupkg; do
            echo "üì§ Publishing $(basename "$package")..."
            dotnet nuget push "$package" -k ${{ secrets.NUGET_API_KEY }} -s https://api.nuget.org/v3/index.json --skip-duplicate
            echo "  ‚úì Published $(basename "$package")"
          done
