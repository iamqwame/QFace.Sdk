name: Build and Publish NuGet Packages

on:
  push:
    branches: [master]
    tags: ["v*.*.*"]
  workflow_dispatch:

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 6.0.x

      - name: Fix documentation paths
        run: |
          ROOT_DIR=$(pwd)
          
          for project_dir in ./src/QFace.Sdk.*; do
            echo "Updating paths for $project_dir"
          
            mkdir -p "$project_dir/docs/shared"
            cp README.md "$project_dir/"
          
            if [ -f "docs/actor-system.md" ]; then
              cp docs/actor-system.md "$project_dir/docs/"
            fi
          
            if [ -f "docs/rabbitmq.md" ]; then
              cp docs/rabbitmq.md "$project_dir/docs/"
            fi
          
            if [ -f "docs/rabbitmq-messaging.md" ]; then
              cp docs/rabbitmq-messaging.md "$project_dir/docs/"
            fi
          
            if [ -d "docs/shared" ]; then
              cp -r docs/shared/* "$project_dir/docs/shared/"
            fi
          
            project_file="$project_dir/$(basename "$project_dir").csproj"
            sed -i 's/<None Include="\$(SolutionDir)README.md"/<None Include="README.md"/g' "$project_file"
            sed -i 's/<None Include="\$(SolutionDir)docs\//<None Include="docs\//g' "$project_file"
          done

      - name: Build and Pack SDK projects
        run: |
          mkdir -p ./nupkgs
          
          for project in ./src/QFace.Sdk.*/*.csproj; do
            echo "Processing $project..."
            dotnet restore "$project"
            dotnet build "$project" -c Release --no-restore
            dotnet pack "$project" -c Release --no-build -o ./nupkgs
          done
          
          echo "Created packages:"
          ls -la ./nupkgs/

      - name: Publish to NuGet
        if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
        run: |
          dotnet nuget push ./nupkgs/*.nupkg -k ${{ secrets.NUGET_API_KEY }} -s https://api.nuget.org/v3/index.json --skip-duplicate
